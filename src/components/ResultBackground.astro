---
import CloseIcon from "../icons/CloseIcon.astro";
import SearchIcon from "../icons/SearchIcon.astro";
import ResultContainer from "./ResultContainer.astro";

// Fetch all glossary terms from MDX frontmatter for client-side search
const matches = import.meta.glob("../pages/glossary/*.mdx", { eager: true });
const glossaryData = Object.values(matches)
    .map((file: any) => ({
        url: file.url,
        term: file.frontmatter?.term || "",
        description: file.frontmatter?.description || "",
    }))
    .filter((item) => item.term);
---

<div
    id="result-background"
    class="fixed inset-0 z-[200] hidden bg-slate-950/40 backdrop-blur-2xl flex flex-col items-center justify-start pt-[10vh] px-4 sm:px-6 transition-all duration-300 opacity-0"
>
    <!-- Search Modal Content -->
    <div
        id="search-modal"
        class="w-full max-w-[800px] transform scale-95 transition-all duration-300"
    >
        <div
            class="relative bg-white dark:bg-slate-900/80 rounded-3xl border border-white/20 dark:border-slate-800/50 shadow-2xl overflow-hidden min-h-[400px] flex flex-col"
        >
            <div
                class="relative p-6 border-b border-slate-200 dark:border-slate-800/50"
            >
                <div class="flex items-center gap-4">
                    <div class="text-blue-500 dark:text-blue-400">
                        <SearchIcon dimension={24} />
                    </div>
                    <input
                        id="functional-search-input"
                        type="search"
                        autocomplete="off"
                        class="w-full bg-transparent text-md font-medium text-slate-900 dark:text-white outline-none placeholder:text-slate-400"
                        placeholder="Search for terms, technologies..."
                    />
                    <button
                        id="bg-close-btn-top"
                        class="p-2 text-slate-400 hover:text-red-400 transition-colors"
                        aria-label="Close search"
                    >
                        <CloseIcon dimension={24} />
                    </button>
                </div>
            </div>

            <div
                id="results-wrapper"
                class="flex-1 overflow-y-auto max-h-[60vh] custom-scrollbar"
            >
                <ResultContainer />
            </div>

            <div
                class="p-4 bg-slate-50 dark:bg-white/[0.02] border-t border-slate-200 dark:border-slate-800/50 flex items-center justify-between text-[11px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest"
            >
                <div class="flex items-center gap-4">
                    <span class="flex items-center gap-1.5">
                        <kbd
                            class="px-1.5 py-0.5 rounded bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 font-mono shadow-sm"
                            >â†µ</kbd
                        >
                        Select
                    </span>
                    <span
                        class="flex items-center gap-1.5 text-blue-500 dark:text-blue-400"
                    >
                        <span id="result-count">0</span> Results Found
                    </span>
                </div>
                <div class="flex items-center gap-4">
                    <span class="flex items-center gap-1.5">
                        <kbd
                            class="px-1.5 py-0.5 rounded bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 font-mono shadow-sm"
                            >ESC</kbd
                        >
                        Close
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<script is:inline define:vars={{ glossaryData }}>
    const resultBackground = document.getElementById("result-background");
    const searchModal = document.getElementById("search-modal");
    const closeBtns = [
        document.getElementById("bg-close-btn-top"),
        resultBackground,
    ];
    const functionalInput = document.getElementById("functional-search-input");

    function closeSearch() {
        resultBackground.classList.add("opacity-0");
        searchModal.classList.add("scale-95");
        setTimeout(() => {
            resultBackground.style.display = "none";
            document.body.style.overflow = "auto";
        }, 300);
    }

    closeBtns.forEach((btn) => {
        btn?.addEventListener("click", (e) => {
            if (
                e.target === resultBackground ||
                e.currentTarget === document.getElementById("bg-close-btn-top")
            ) {
                closeSearch();
            }
        });
    });

    window.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && resultBackground.style.display === "flex") {
            closeSearch();
        }
    });

    searchModal.addEventListener("click", (e) => e.stopPropagation());

    if (functionalInput) {
        functionalInput.addEventListener("input", (e) => {
            const query = e.target.value.toLowerCase().trim();
            renderResults(query);
        });
    }

    function renderResults(query = "") {
        const resultsContainer = document.getElementById("search-results-list");
        const countDisplay = document.getElementById("result-count");

        if (!query) {
            if (resultsContainer) resultsContainer.innerHTML = "";
            if (countDisplay) countDisplay.textContent = "0";
            return;
        }

        const filtered = glossaryData.filter(
            (item) =>
                item.term.toLowerCase().includes(query) ||
                item.description.toLowerCase().includes(query),
        );

        if (countDisplay) countDisplay.textContent = filtered.length;

        if (!resultsContainer) return;

        if (filtered.length === 0) {
            resultsContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center p-12 text-slate-400 dark:text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mb-4 opacity-20"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    <p class="text-sm font-medium">No matches found for "${query}"</p>
                </div>
            `;
            return;
        }

        resultsContainer.innerHTML = filtered
            .map(
                (item) => `
            <a href="${item.url}" class="group flex items-center justify-between p-4 mx-4 my-1 rounded-2xl hover:bg-blue-500/5 dark:hover:bg-blue-400/5 border border-transparent hover:border-blue-500/20 transition-all">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-400 group-hover:bg-blue-500 group-hover:text-white transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-2"/><path d="M16 3v4"/><path d="M8 3v4"/><path d="M3 11h18"/><path d="M5 15h.01"/><path d="M8 15h.01"/><path d="M11 15h.01"/><path d="M14 15h.01"/><path d="M17 15h.01"/><path d="M5 19h.01"/><path d="M8 19h.01"/><path d="M11 19h.01"/><path d="M14 19h.01"/><path d="M17 19h.01"/></svg>
                    </div>
                    <div>
                        <h4 class="text-slate-900 dark:text-slate-100 font-bold tracking-tight">${item.term}</h4>
                        <p class="text-xs text-slate-500 dark:text-slate-500 line-clamp-1">${item.description || "View glossary term details"}</p>
                    </div>
                </div>
                <div class="opacity-0 group-hover:opacity-100 transition-opacity text-blue-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                </div>
            </a>
        `,
            )
            .join("");
    }
</script>

<style is:inline>
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.1);
        border-radius: 20px;
    }
    .custom-scrollbar:hover::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.2);
    }
</style>
